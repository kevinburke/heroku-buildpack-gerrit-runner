#!/usr/bin/env bash
# bin/release <build-dir>

set -exo pipefail

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
BUILD_DIR=$1

chmod 755 "$BIN_DIR/gerrit.sh"
mkdir -p "$BUILD_DIR/bin"
mkdir -p "$BUILD_DIR/etc"
cp -a "$BIN_DIR/gerrit.sh" "$BUILD_DIR/bin/"
cat "$BIN_DIR/../etc/gerrit.config"
cp -a "$BIN_DIR/../etc/gerrit.config" "$BUILD_DIR/etc/"

# gerrit basePath
mkdir -p "$BUILD_DIR/cache"
mkdir -p "$BUILD_DIR/data"
mkdir -p "$BUILD_DIR/git"
mkdir -p "$BUILD_DIR/index"
mkdir -p "$BUILD_DIR/logs"

cat <<EOF
---
config_vars:
  PATH: /app/.jdk/bin:/usr/local/bin:/usr/bin:/bin
  JAVA_HOME: /app/.jdk
  JAVA_OPTS: -Xmx384m -Xss512k -XX:+UseCompressedOops
  MAVEN_OPTS: -Xmx384m -Xss512k -XX:+UseCompressedOops
  START_STOP_DAEMON: 0

default_process_types:
  web: echo "starting Gerrit" && bash bin/gerrit.sh status && java -jar bin/gerrit.war reindex -d /app && bash bin/gerrit.sh run
EOF
